(function(){function o(e,t){if(!t)t={};for(var n in e){if(t[n]===undefined)t[n]=e[n]}return t}function u(){this._callbacks=[];this._errCallbacks=[];this._resolved=0;this._result=null}function f(e,t){this.data=e;this.options=o(a,t);this.operation=new u;this.operation.resolve(null,this.data);this.requiredScripts=[];this.requiredFunctions=[]}var e=typeof module!=="undefined"&&module.exports;var t=!(typeof window!=="undefined"&&this===window);var n=n||function(e){setTimeout(e,0)};var r=t?require(__dirname+"/Worker.js"):self.Worker;var i=typeof self!=="undefined"?self.URL?self.URL:self.webkitURL:null;var s=t||self.Worker?true:false;u.prototype.resolve=function(e,t){if(!e){this._resolved=1;this._result=t;for(var n=0;n<this._callbacks.length;++n){this._callbacks[n](t)}}else{this._resolved=2;this._result=e;for(var r=0;r<this._errCallbacks.length;++r){this._errCallbacks[r](t)}}this._callbacks=[];this._errCallbacks=[]};u.prototype.then=function(e,t){if(this._resolved===1){if(e){e(this._result)}return}else if(this._resolved===2){if(t){t(this._result)}return}if(e){this._callbacks[this._callbacks.length]=e}if(t){this._errCallbacks[this._errCallbacks.length]=t}return this};var a={evalPath:t?__dirname+"/eval.js":null,maxWorkers:t?require("os").cpus().length:4,synchronous:true,env:{},envNamespace:"env"};f.isSupported=function(){return s};f.prototype.getWorkerSource=function(e,n){var r=this;var i="";var s=0;if(!t&&this.requiredScripts.length!==0){i+='importScripts("'+this.requiredScripts.join('","')+'");\r\n'}for(s=0;s<this.requiredFunctions.length;++s){if(this.requiredFunctions[s].name){i+="var "+this.requiredFunctions[s].name+" = "+this.requiredFunctions[s].fn.toString()+";"}else{i+=this.requiredFunctions[s].fn.toString()}}n=JSON.stringify(n||{});var o=this.options.envNamespace;if(t){return i+'process.on("message", function(e) {global.'+o+" = "+n+";process.send(JSON.stringify(("+e.toString()+")(JSON.parse(e).data)))})"}else{return i+"self.onmessage = function(e) {var global = {}; global."+o+" = "+n+";self.postMessage(("+e.toString()+")(e.data))}"}};f.prototype.require=function(){var e=Array.prototype.slice.call(arguments,0),t;for(var n=0;n<e.length;n++){t=e[n];if(typeof t==="string"){this.requiredScripts.push(t)}else if(typeof t==="function"){this.requiredFunctions.push({fn:t})}else if(typeof t==="object"){this.requiredFunctions.push(t)}}return this};f.prototype._spawnWorker=function(e,n){var s;var o=this.getWorkerSource(e,n);if(t){s=new r(this.options.evalPath);s.postMessage(o)}else{if(r===undefined){return undefined}try{if(this.requiredScripts.length!==0){if(this.options.evalPath!==null){s=new r(this.options.evalPath);s.postMessage(o)}else{throw new Error("Can't use required scripts without eval.js!")}}else if(!i){throw new Error("Can't create a blob URL in this browser!")}else{var u=new Blob([o],{type:"text/javascript"});var a=i.createObjectURL(u);s=new r(a)}}catch(f){if(this.options.evalPath!==null){s=new r(this.options.evalPath);s.postMessage(o)}else{throw f}}}return s};f.prototype.spawn=function(e,t){var r=this;var i=new u;t=o(this.options.env,t||{});this.operation.then(function(){var s=r._spawnWorker(e,t);if(s!==undefined){s.onmessage=function(e){s.terminate();r.data=e.data;i.resolve(null,r.data)};s.postMessage(r.data)}else if(r.options.synchronous){n(function(){r.data=e(r.data);i.resolve(null,r.data)})}else{throw new Error("Workers do not exist and synchronous operation not allowed!")}});this.operation=i;return this};f.prototype._spawnMapWorker=function(e,t,r,i){var s=this;var o=s._spawnWorker(t,i);if(o!==undefined){o.onmessage=function(t){o.terminate();s.data[e]=t.data;r()};o.postMessage(s.data[e])}else if(s.options.synchronous){n(function(){s.data[e]=t(s.data[e]);r()})}else{throw new Error("Workers do not exist and synchronous operation not allowed!")}};f.prototype.map=function(e,t){function s(){if(++i===n.data.length){a.resolve(null,n.data)}else if(r<n.data.length){n._spawnMapWorker(r++,e,s,t)}}t=o(this.options.env,t||{});if(!this.data.length){return this.spawn(e,t)}var n=this;var r=0;var i=0;var a=new u;this.operation.then(function(){for(;r-i<n.options.maxWorkers&&r<n.data.length;++r){n._spawnMapWorker(r,e,s,t)}});this.operation=a;return this};f.prototype._spawnReduceWorker=function(e,t,r,i){var s=this;var o=s._spawnWorker(t,i);if(o!==undefined){o.onmessage=function(e){o.terminate();s.data[s.data.length]=e.data;r()};o.postMessage(e)}else if(s.options.synchronous){n(function(){s.data[s.data.length]=t(e);r()})}else{throw new Error("Workers do not exist and synchronous operation not allowed!")}};f.prototype.reduce=function(e,t){function i(o){--n;if(r.data.length===1&&n===0){r.data=r.data[0];s.resolve(null,r.data)}else if(r.data.length>1){++n;r._spawnReduceWorker([r.data[0],r.data[1]],e,i,t);r.data.splice(0,2)}}t=o(this.options.env,t||{});if(!this.data.length){throw new Error("Can't reduce non-array data")}var n=0;var r=this;var s=new u;this.operation.then(function(){if(r.data.length===1){s.resolve(null,r.data[0])}else{for(var o=0;o<r.options.maxWorkers&&o<Math.floor(r.data.length/2);++o){++n;r._spawnReduceWorker([r.data[o*2],r.data[o*2+1]],e,i,t)}r.data.splice(0,o*2)}});this.operation=s;return this};f.prototype.then=function(e,t){var n=this;var r=new u;this.operation.then(function(){var t=e(n.data);if(t!==undefined){n.data=t}r.resolve(null,n.data)},t);this.operation=r;return this};if(e){module.exports=f}else{self.Parallel=f}})()